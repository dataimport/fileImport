<!DOCTYPE HTML PUBliC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3c.org/TR/1999/REC-html401-19991224/loose.dtd">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>入库任务监控</TITLE>
<META http-equiv=Content-Type content="text/html; charset=utf-8">
<script src="../static_bootstrap/js/jquery-1.9.1.min.js"></script>
<script src="../static_bootstrap/js/jquery-migrate-1.0.0.min.js"></script>
<link href="../static_bootstrap/css/bootstrap-3.3.5.min.css" rel="stylesheet">
<link href="../static_bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
<link id="base-style-responsive" href="../static_bootstrap/css/style-responsive.css" rel="stylesheet">
<link href="../static_bootstrap/css/my.css" type=text/css rel=stylesheet>

</HEAD>
<BODY>
	<div class="container" style="width: 100%;">
	    
	    <#if status??&&(status==888 || status==0 || status==1 || status==-2)>
	   <!--  <script language=javascript>setInterval("window.location.reload()",5000)</script> -->
		<div class="row">
			<h4 style="font-weight: bold;margin-top: 0px;">当前任务总数:&nbsp;&nbsp;${page.totalCount!}</h4>
			<div class="progress">
				<div class="label-info label-progress" style="width: 33%;" onclick="showList(1)">
				<#if totalCount==0>
					<#assign runingPercent =0>
					<#assign failedPercent = 0>
					<#assign waitPercent = 0>
				<#else>
					<#assign runingPercent = ((runingCount!/totalCount!)*100)?string("0.##")>
					<#assign failedPercent = ((failedCount!/totalCount!)*100)?string("0.##")>
					<#assign waitPercent = ((waitCount!/totalCount!)*100)?string("0.##")>
				</#if>				
				执行中${runingCount!}/${runingPercent!}%</div>							
				<div class="label-danger label-progress" style="width: 33%;" onclick="showList(-2)">失败${failedCount!}/${failedPercent!}%</div>
				<div class="label-default label-progress" style="width: 34%;"  onclick="showList(0)">未启动${waitCount!}/${waitPercent!}%</div>
			</div>
		</div>
		</#if>
		<div class="row" id="tableInfo">
				<table class="table table-bordered" style="width:99%;margin-left:5px;">
							  <thead>
								  <tr class="active">
									  <th>序号</th>
									  <th>任务名称</th>
									  <th>创建者</th>
									  <th>状态</th>
									  <th>计划时间</th>
									  <th>启动时间</th>
									  <th>执行时长</th>
									  <th>百分比/处理数量</th>
									  <th>数据总条目</th>
									  <th>操作</th>
								  </tr>
							  </thead>   
							  <tbody>
							  
							  <#if (list?size>0)>
							  <#list list as task>
								<tr>
									<td>${task_index+1!}</td>
									<td class="center">${task.tableName!}-${task.origin!}</td>
									<td class="center">${task.createUser!}</td>  
									<td class="center">
									    <#if task.taskStatus==0>
										    <span onclick="showList(0)" class="label label-default">未启动</span>
										<#elseif task.taskStatus==1>
									    	<span onclick="showList(1)" class="label label-info">执行中</span>									    
									    <#elseif task.taskStatus==-2>
					 				        <span onclick="showList(-2)" class="label label-danger">异常</span>
									    <#elseif task.taskStatus==2>
									        <span onclick="showList(2)" class="label label-success">已完成</span>
									    </#if>
									</td>  
									<td class="center">${task.runTime!}</td>
									<td class="center">${task.startDate!}</td>
									<td class="center">${task.timeUse!}</td> 
									<td class="center" id="td_${task.id}">
									<#if task.taskStatus==2>
										<font color="green">100%</font>
									<#elseif task.totalCount??&&task.totalCount!=0&&(task.totalCount!>=task.runNum!)>
	   
									   
									   <#assign percent = ((task.runNum!/task.totalCount!)*100)?string("0.##")>
									   
									   <#if percent=="100">
									    <font color="#0D3EEF">${percent!}%</font> 
									   <#else>
									     <font color="#EF0F1A">${percent!}%</font> 
									   </#if>		
									   <#else>
									   		0%
									   </#if>
									   /${task.runNum!}
									   </td>
									<td class="center" id="tdCount_${task.id}">${task.runNum!}/${task.totalCount!}</td> 
									<td class="center">
										<button type="button" name="previewClick"  data-path="${task.filePath!}" class="btn btn-primary btn-xs">重新导入</button>
										<#if task.totalCount??&&task.runNum!=task.totalCount!>
								        <button type="button" name="failDataClick" data-path="${task.tableNameAlias!}" data-path2="${task.uid!}" class="btn btn-primary btn-xs">错误日志</button>
								        </#if>
								</td>                                     
								</tr>
								</#list>
								<#else>
								  <tr>
									<td colspan="10">
									            当前队列中，没有执行的任务
									</td>
								  </tr>
								</#if>
							  </tbody>
						 </table> 
<#if (page.totalPage>1)>
<script src="../static_bootstrap/js/bootstrap-paginator.js"></script>
<div style="margin: 0 auto;text-align: center; width: 100%;"><ul id="page"></ul></div>
<script type="text/javascript">
var element = jQuery('#page');

var options = {
    bootstrapMajorVersion:3,//这个不用改
    currentPage: ${page.pageNo},
    numberOfPages: 10,
    totalPages:${page.totalPage},

    itemTexts: function (type, page, current) {
      switch (type) {
        case "first":
          return "首页";
        case "prev":
          return "上一页";
        case "next":
          return "下一页";
        case "last":
          return "末页";
        case "page":
          return page;
      }
    },
    onPageClicked: function (event, originalEvent, type, page) {
        location.href="list.htm?status=${status!}&pageNo="+page+"&pageSize=${page.pageSize}";
    }
}
element.bootstrapPaginator(options);

</script>

<#else>
    <#if status??&&(status==888 || status==0 || status==1 || status==-2)>
	    <button type="button" onclick="showList()" class="btn btn-primary" style="float:left;margin-top: 15px;">查看入库任务日志</button>
	</#if>
</#if>
 
	</div>
</div>
<form id="previewForm" action="../file/preview.htm" method="post">
<input type="hidden" name="filePath" id="filePath" value=""/>
</form>
<form id="failDataForm" action="../mongo/failCollection.htm" method="post">
<input type="hidden" name="tableNameAlias" id="tableNameAlias" value=""/>
<input type="hidden" name="uid" id="uid" value=""/>
</form>
</BODY>
<script src="../static_bootstrap/js/ie10-viewport-bug-workaround.js"></script>
<script type="text/javascript" src="../js/jquery/jquery.timers-1.2.js" id="st-main"></script>
<script type="text/javascript" src="../js/jquery/jquery.corner.js" id="st-main"></script>
<script type="text/javascript" src="../js/common.js" id="st-main"></script>
<script>
function showList(status){
	if (typeof status == "undefined")
	{
		window.location.href="list.htm?pageSize=${page.pageSize}";
	}else{
		window.location.href="list.htm?status="+status+"&pageSize=${page.pageSize}";
	}
 	 
}

$("button[name='previewClick'").click(function(){
	var path= encodeURIComponent($(this).attr("data-path"));
	$("#filePath").val(path);
	$("#previewForm").submit();
});

$("button[name='failDataClick'").click(function(){
	var path= encodeURIComponent($(this).attr("data-path"));
	$("#tableNameAlias").val(path+"_fali");
	var uid= encodeURIComponent($(this).attr("data-path2"));
	$("#uid").val(uid);
	
	$("#failDataForm").submit();
});

//3s刷新 一次,最多执行 5分钟
var sta= "${status!}";
var runNum=0;
if(sta==""){
	runNum=10000;
}
$('body').everyTime('3s','C',function(){
	runNum++;	
    if(runNum>100){
    	$('body').stopTime();
    }else{
    	getPercent();	
    }
		
},0,true);


function getPercent(){
  
	$.ajax(  
            {  
                url:'list.htm', 
                type:"post",  
                async:true,  
                data:{
                	'status':'${status!}',
                	'pageNo':'${pageNo!}',
                	'type':'ajax',
                	},  
                dataType:"html",  
                timeout:"1000",  
                async:false,
                error:function(){
                	percent = 0;
                },  
                success:function(data)  
                {  	                	
                	$("#tableInfo").html(data);
                	/**
                	 $.each(data, function (n, task) {
                		 
     					if(task.totalCount!=0&&(task.totalCount>=task.runNum))
     				   	{
						  if(task.firstLineIgnore=true){
							  var  percent = (((task.runNum+1)/task.totalCount)*100).toFixed(2)
						  }else{
							  var  percent =  ((task.runNum/task.totalCount)*100).toFixed(2)
						  }		
						  
						  if(percent==100){
							  var html ='<font color="#0D3EEF">'+percent+'%</font>/'+task.runNum;
						  }else{
							  var html ='<font color="#EF0F1A">'+percent+'%</font>/'+task.runNum;
						  }
						  $("#td_"+task.id).html(html);		
						  $("#tdCount_"+task.id).text(task.totalCount);	
     				   }else{
     					 $("#td_"+task.id).text("计算中");     		
     					 $("#tdCount_"+task.id).text("计算中");	
     				   }		                		
                      });   
                	**/
                }  
            }  
        );

}
</script>
		
</HTML>